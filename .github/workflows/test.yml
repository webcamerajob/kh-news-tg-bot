name: WireGuard VPN + CF-Protected API Fetch

on:
  workflow_dispatch:

env:
  TARGET_URL: https://www.khmertimeskh.com/wp-json/wp/v2/categories?slug=national

jobs:
  vpn-and-fetch:
    runs-on: ubuntu-latest

    steps:
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      run: |
        echo "‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ–º Google –¥–æ VPN‚Ä¶"
        curl -v --connect-timeout 5 https://www.google.com -o /dev/null \
          || { echo "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"; exit 1; }

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WireGuard –∏ —É—Ç–∏–ª–∏—Ç
      run: |
        sudo apt-get update
        sudo apt-get install -y wireguard-tools resolvconf dnsutils curl

    - name: üîê –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ WireGuard –∫–æ–Ω—Ñ–∏–≥–∞
      run: |
        mkdir -p $HOME/wg
        echo "${{ secrets.WG_CONFIG }}" > $HOME/wg/wg0.conf
        chmod 600 $HOME/wg/wg0.conf

    - name: üöÄ –ü–æ–¥–Ω—è—Ç–∏–µ VPN –∏ —Ñ–∏–∫—Å–∞—Ü–∏—è DNS
      run: |
        echo "‚Üí –ü–æ–¥–Ω–∏–º–∞–µ–º VPN‚Ä¶"
        sudo wg-quick up $HOME/wg/wg0.conf
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf > /dev/null
        echo "VPN IP: $(curl -s https://ipinfo.io/ip)"

    - name: üåê –¢–µ—Å—Ç Google —á–µ—Ä–µ–∑ VPN
      run: |
        echo "‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ–º Google —á–µ—Ä–µ–∑ VPN‚Ä¶"
        curl -v --connect-timeout 5 https://www.google.com -o /dev/null \
          || echo "‚ö†Ô∏è Google –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ VPN"

    - name: üß© Setup Node.js & Playwright
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Playwright
      run: |
        npm init -y
        npm install playwright
        npx playwright install --with-deps chromium

    - name: üïµÔ∏è‚Äç‚ôÇÔ∏è Fetch CF-Protected API via Headless Chromium
      env:
        TARGET_URL: ${{ env.TARGET_URL }}
      run: |
        node << 'EOF'
        const { chromium } = require('playwright');
        (async () => {
          console.log(`‚Üí –û—Ç–∫—Ä—ã–≤–∞—é ${process.env.TARGET_URL} –≤ headless Chromium‚Ä¶`);
          const browser = await chromium.launch({ args: ['--no-sandbox'] });
          const page = await browser.newPage();
          const response = await page.goto(process.env.TARGET_URL, { waitUntil: 'networkidle' });
          const status = response.status();
          const body = await response.text();
          console.log(`Status: ${status}`);
          if (status === 200) {
            console.log('Body snippet:', body.slice(0, 200), '‚Ä¶');
          } else {
            console.log('Error body snippet:', body.slice(0, 200), '‚Ä¶');
            process.exit(1);
          }
          await browser.close();
        })();
        EOF

    - name: üõë –û—Ç–∫–ª—é—á–µ–Ω–∏–µ VPN
      if: always()
      run: |
        echo "‚Üí –û—Ç–∫–ª—é—á–∞–µ–º VPN‚Ä¶"
        sudo wg-quick down $HOME/wg/wg0.conf || echo "WireGuard —É–∂–µ –æ—Ç–∫–ª—é—á—ë–Ω"
