name: VPN Parser & Poster (No Cache)

on:
  workflow_dispatch:

jobs:
  run-via-vpn:
    runs-on: ubuntu-latest

    steps:
    - name: üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      with:
        path: .

    - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        sudo apt-get update
        sudo apt-get install -y wireguard-tools resolvconf curl python3-pip
        pip3 install requests beautifulsoup4 Pillow python-telegram-bot

    - name: üìÅ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ WireGuard-–∫–æ–Ω—Ñ–∏–≥–∞
      run: |
        mkdir -p $HOME/wg
        echo "${{ secrets.WG_CONFIG }}" > $HOME/wg/wg0.conf
        chmod 600 $HOME/wg/wg0.conf

    - name: üîê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN –∏ DNS
      run: |
        sudo wg-quick up $HOME/wg/wg0.conf
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
        echo "VPN IP: $(curl -s https://ipinfo.io/ip)"

    - name: üß† –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ (main.py)
      working-directory: .
      run: |
        echo "‚Üí –ó–∞–ø—É—Å–∫ main.py..."
        python3 main.py || echo "‚ö†Ô∏è main.py –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"

    - name: üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è catalog.json
      run: |
        if [ ! -f articles/catalog.json ]; then
          echo "‚ùå catalog.json –Ω–µ —Å–æ–∑–¥–∞–Ω ‚Äî –ø—Ä–µ—Ä—ã–≤–∞–µ–º –ø–æ—Å—Ç–µ—Ä"
          exit 1
        else
          echo "‚úÖ catalog.json –Ω–∞–π–¥–µ–Ω"
        fi

    - name: üõë –û—Ç–∫–ª—é—á–µ–Ω–∏–µ VPN
      if: always()
      run: |
        echo "‚Üí –û—Ç–∫–ª—é—á–µ–Ω–∏–µ WireGuard..."
        sudo wg-quick down $HOME/wg/wg0.conf || echo "WireGuard —É–∂–µ –≤—ã–∫–ª—é—á–µ–Ω"

    - name: üì§ –ó–∞–ø—É—Å–∫ –ø–æ—Å—Ç–µ—Ä–∞ (poster.py)
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
      run: |
        python3 poster.py || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ poster.py"


