name: VPN Parser & Poster

on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
    - name: üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
      id: setup_check
      run: |
        if [ -f "$HOME/.env_ready" ]; then
          echo "install_needed=false" >> $GITHUB_OUTPUT
        else
          echo "install_needed=true" >> $GITHUB_OUTPUT

    - name: üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ)
      if: steps.setup_check.outputs.install_needed == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y wireguard-tools resolvconf curl python3-pip
        pip3 install -U requests beautifulsoup4
        echo "done" > $HOME/.env_ready

    - name: üìÅ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ VPN-–∫–æ–Ω—Ñ–∏–≥–∞
      run: |
        mkdir -p $HOME/wg
        echo "${{ secrets.WG_CONFIG }}" > $HOME/wg/wg0.conf
        chmod 600 $HOME/wg/wg0.conf

    - name: üîê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WireGuard –∏ DNS —Ñ–∏–∫—Å–∞—Ü–∏—è
      run: |
        sudo wg-quick up $HOME/wg/wg0.conf
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf > /dev/null
        echo "VPN IP: $(curl -s https://ipinfo.io/ip)"

    - name: üß† –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ (main.py) –ø–æ–¥ VPN
      run: |
        echo "‚Üí –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–µ—Ä main.py —á–µ—Ä–µ–∑ VPN‚Ä¶"
        python3 main.py || echo "–ü–∞—Ä—Å–µ—Ä –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"

    - name: üõë –û—Ç–∫–ª—é—á–µ–Ω–∏–µ WireGuard
      if: always()
      run: |
        echo "‚Üí –û—Ç–∫–ª—é—á–∞–µ–º VPN‚Ä¶"
        sudo wg-quick down $HOME/wg/wg0.conf || echo "WireGuard —É–∂–µ –æ—Ç–∫–ª—é—á—ë–Ω"

    - name: üì§ –ó–∞–ø—É—Å–∫ –ø–æ—Å—Ç–µ—Ä–∞ (poster.py)
      run: |
        echo "‚Üí –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å—Ç–µ—Ä poster.py‚Ä¶"
        python3 poster.py || echo "–ü–æ—Å—Ç–µ—Ä –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
