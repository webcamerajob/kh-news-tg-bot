name: VPN + CF-Protected API Fetch via Playwright

on:
  workflow_dispatch:

env:
  TARGET_URL: https://www.khmertimeskh.com/wp-json/wp/v2/categories?slug=national
  ROOT_URL: https://www.khmertimeskh.com

jobs:
  vpn-cf-bypass:
    runs-on: ubuntu-latest

    steps:
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–æ VPN
      run: |
        echo "‚Üí Google –¥–æ VPN‚Ä¶"
        curl -s --connect-timeout 5 https://www.google.com -o /dev/null \
          || { echo "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"; exit 1; }

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ VPN –∏ —É—Ç–∏–ª–∏—Ç
      run: |
        sudo apt-get update
        sudo apt-get install -y wireguard-tools resolvconf dnsutils curl python3-pip

    - name: üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WireGuard
      run: |
        mkdir -p $HOME/wg
        echo "${{ secrets.WG_CONFIG }}" > $HOME/wg/wg0.conf
        chmod 600 $HOME/wg/wg0.conf
        sudo wg-quick up $HOME/wg/wg0.conf
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf > /dev/null
        echo "VPN IP: $(curl -s https://ipinfo.io/ip)"

    - name: üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ Google —á–µ—Ä–µ–∑ VPN
      run: |
        echo "‚Üí Google —á–µ—Ä–µ–∑ VPN‚Ä¶"
        curl -s --connect-timeout 5 https://www.google.com -o /dev/null \
          || echo "‚ö†Ô∏è Google –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ VPN"

    - name: üß© Setup Node.js & Playwright
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Playwright
      run: |
        npm init -y
        npm install playwright
        npx playwright install --with-deps chromium

    - name: üïµÔ∏è Fetch CF-Protected JSON via Headless Chromium
      env:
        TARGET_URL: ${{ env.TARGET_URL }}
        ROOT_URL: ${{ env.ROOT_URL }}
      run: |
        node << 'EOF'
        const { chromium } = require('playwright');

        (async () => {
          const browser = await chromium.launch({ args: ['--no-sandbox'] });
          const context = await browser.newContext();
          const page = await context.newPage();

          console.log(`‚Üí –†–µ—à–∞–µ–º JS-—á–µ–ª–ª–µ–Ω–¥–∂ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ‚Ä¶`);
          await page.goto(process.env.ROOT_URL, {
            waitUntil: 'networkidle',
            timeout: 60000
          });

          console.log(`‚Üí –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ API: ${process.env.TARGET_URL}`);
          const response = await page.goto(process.env.TARGET_URL, {
            waitUntil: 'load',
            timeout: 30000
          });

          const status = response.status();
          const body = await response.text();

          console.log(`Status: ${status}`);
          if (status === 200) {
            console.log('Body snippet:', body.slice(0, 200), '‚Ä¶');
            process.exit(0);
          } else {
            console.log('Error body snippet:', body.slice(0, 200), '‚Ä¶');
            process.exit(1);
          }
        })();
        EOF

    - name: üõë –û—Ç–∫–ª—é—á–µ–Ω–∏–µ VPN
      if: always()
      run: |
        echo "‚Üí –í—ã–∫–ª—é—á–∞–µ–º VPN‚Ä¶"
        sudo wg-quick down $HOME/wg/wg0.conf || echo "VPN —É–∂–µ –±—ã–ª –æ—Ç–∫–ª—é—á—ë–Ω"
