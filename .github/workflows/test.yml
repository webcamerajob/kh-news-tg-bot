name: WireGuard VPN Connectivity Test

on:
  workflow_dispatch:

env:
  TARGET_URL: https://www.khmertimeskh.com/wp-json/wp/v2/categories?slug=national

jobs:
  vpn-test:
    runs-on: ubuntu-latest

    steps:
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      run: |
        curl -s --connect-timeout 5 https://google.com -I \
          || { echo "–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞"; exit 1; }

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WireGuard –∏ —É—Ç–∏–ª–∏—Ç
      run: |
        sudo apt-get update
        sudo apt-get install -y wireguard-tools resolvconf dnsutils curl

    - name: üìÅ –ó–∞–ø–∏—Å—å –∫–æ–Ω—Ñ–∏–≥–∞ WireGuard
      run: |
        mkdir -p $HOME/wg
        echo "${{ secrets.WG_CONFIG }}" > $HOME/wg/wg0.conf
        chmod 600 $HOME/wg/wg0.conf

    - name: üîê –ü–æ–¥–Ω—è—Ç–∏–µ VPN –∏ —Ñ–∏–∫—Å–∞—Ü–∏—è DNS
      run: |
        sudo wg-quick up $HOME/wg/wg0.conf
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf > /dev/null
        echo "VPN IP: $(curl -s https://ipinfo.io/ip)"

    - name: üåê –¢–µ—Å—Ç Google —á–µ—Ä–µ–∑ VPN
      run: |
        echo "‚Üí Testing https://www.google.com over VPN‚Ä¶"
        curl -v --connect-timeout 5 https://www.google.com -o /dev/null \
          || echo "‚ö†Ô∏è Google –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ VPN"

    - name: üîó –¢–µ—Å—Ç —Ü–µ–ª–µ–≤–æ–≥–æ URL —á–µ—Ä–µ–∑ VPN
      run: |
        echo "‚Üí Testing $TARGET_URL over VPN‚Ä¶"
        curl -v --connect-timeout 10 "$TARGET_URL" -o /dev/null \
          || echo "‚ö†Ô∏è –¶–µ–ª–µ–≤–æ–π URL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ VPN"

    - name: üõë –û—Ç–∫–ª—é—á–µ–Ω–∏–µ VPN
      if: always()
      run: |
        sudo wg-quick down $HOME/wg/wg0.conf || echo "VPN —É–∂–µ –æ—Ç–∫–ª—é—á—ë–Ω"
