name: WireGuard VPN + CF Bypass

on:
  workflow_dispatch:

jobs:
  vpn-bypass:
    runs-on: ubuntu-latest

    steps:
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
      run: |
        curl -s --connect-timeout 5 https://google.com \
          || { echo "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"; exit 1; }

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wireguard-tools \
          resolvconf \
          dnsutils \
          curl

    - name: üìÅ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ WireGuard –∫–æ–Ω—Ñ–∏–≥–∞
      run: |
        mkdir -p $HOME/wg
        echo "${{ secrets.WG_CONFIG }}" > $HOME/wg/wg0.conf
        chmod 600 $HOME/wg/wg0.conf

    - name: üîê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ DNS
      run: |
        sudo wg-quick up $HOME/wg/wg0.conf
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf > /dev/null
        echo "VPN –∞–∫—Ç–∏–≤–µ–Ω. –¢–µ–∫—É—â–∏–π IP: $(curl -s https://ipinfo.io/ip)"

    - name: üõ∞ –ü–æ–ª—É—á–µ–Ω–∏–µ IP —á–µ—Ä–µ–∑ Cloudflare DNS
      id: resolve
      run: |
        DOMAIN="xn----ctbkymw5a2cwa.com"
        # –ø–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π A-–∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ 1.1.1.1
        IP=$(dig +short $DOMAIN @1.1.1.1 | head -n1)
        if [ -z "$IP" ]; then
          echo "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–∑–æ–ª–≤–∏—Ç—å $DOMAIN" >&2
          exit 1
        fi
        echo "DOMAIN=$DOMAIN" >> $GITHUB_ENV
        echo "DOMAIN_IP=$IP" >> $GITHUB_ENV
        echo "$DOMAIN ‚Üí $IP"

    - name: ‚öîÔ∏è –î–µ–π—Å—Ç–≤–∏—è –ø–æ–¥ VPN —Å –æ–±—Ö–æ–¥–æ–º DNS
      run: |
        # curl –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π IP, –ø–æ–¥–º–µ–Ω—è—è Host-–∑–∞–≥–æ–ª–æ–≤–æ–∫
        curl -s -A "Mozilla/5.0" \
          --resolve "${DOMAIN}:443:${DOMAIN_IP}" \
          -L "https://${DOMAIN}" \
          || echo "–ó–∞–ø—Ä–æ—Å –Ω–µ –ø—Ä–æ—à—ë–ª"

    - name: üõë –û—Ç–∫–ª—é—á–µ–Ω–∏–µ VPN
      if: always()
      run: |
        sudo wg-quick down $HOME/wg/wg0.conf || echo "WireGuard —É–∂–µ –æ—Ç–∫–ª—é—á—ë–Ω"
