name: Parse & Post Articles
permissions:
  contents: write
on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  POST_DELAY: 5
  BATCH_LIMIT: 50

jobs:
  parse:
    name: –ü–∞—Ä—Å–∏–Ω–≥ ‚Üí –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (WireGuard)
    runs-on: ubuntu-latest
    env:
      WG_CONFIG: ${{ secrets.WG_CONFIG }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîê Setup WireGuard & DNS
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools resolvconf
          
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ DNS
          echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
          echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf
          
          mkdir -p $HOME/wg
          echo "$WG_CONFIG" > $HOME/wg/wg0.conf
          chmod 600 $HOME/wg/wg0.conf
          sudo wg-quick up $HOME/wg/wg0.conf
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
          ping -c 3 google.com

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements-parser.txt'

      - name: Install parser dependencies
        run: |
          set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
          if [ ! -f "requirements-parser.txt" ]; then
            echo "::error::–§–∞–π–ª requirements-parser.txt –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            ls -la
            exit 1
          fi

          echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ requirements-parser.txt ==="
          cat requirements-parser.txt
          echo "========================================"

          # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip
          python -m pip install --upgrade pip --no-cache-dir

          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å retry
          for i in {1..5}; do
            echo "–ü–æ–ø—ã—Ç–∫–∞ $i —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            if pip install \
              --no-cache-dir \
              --default-timeout=100 \
              -r requirements-parser.txt; then
              echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
              break
            else
              echo "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥..."
              sleep 15
            fi
          done

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
          echo "=== –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã ==="
          pip list
          echo "==========================="

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          pip check || echo "::warning::–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö"

      - name: üß† Run parser
        run: python3 main.py --lang ru --posted-file articles/posted.json

      - name: Apply watermarks
        run: |
          pip install pillow
          python3 watermark_rotator.py

      - name: üõë Teardown WireGuard
        if: always()
        run: sudo wg-quick down $HOME/wg/wg0.conf || true

      - name: Upload parsed-content
        uses: actions/upload-artifact@v4
        with:
          name: parsed-content
          path: articles/*

  post:
    name: Publish new articles
    needs: parse
    runs-on: ubuntu-latest
    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'requirements-poster.txt'

      - name: Install poster requirements
        run: |
          if [ ! -f "requirements-poster.txt" ]; then
            echo "Error: requirements-poster.txt not found!"
            ls -la
            exit 1
          fi
          pip install -r requirements-poster.txt

      - name: Download parsed-content
        uses: actions/download-artifact@v4
        with:
          name: parsed-content
          path: parsed_articles

      - name: Run poster
        run: |
          python3 poster.py \
            --parsed-dir parsed_articles \
            --state-file articles/posted.json \
            --limit $BATCH_LIMIT

      - name: Commit updated posted.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add articles/posted.json
          if ! git diff --cached --quiet; then
            git commit -m "chore: update posted catalog after posting"
            git push
          fi
