name: Parse & Post Articles
permissions:
  contents: write
on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  POST_DELAY: 5
  BATCH_LIMIT: 50

jobs:
  parse:
    name: –ü–∞—Ä—Å–∏–Ω–≥ ‚Üí –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (WireGuard)
    runs-on: ubuntu-latest
    env:
      WG_CONFIG: ${{ secrets.WG_CONFIG }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîê Setup WireGuard & DNS
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools resolvconf
          
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ DNS
          echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
          echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf
          
          mkdir -p $HOME/wg
          echo "$WG_CONFIG" > $HOME/wg/wg0.conf
          chmod 600 $HOME/wg/wg0.conf
          sudo wg-quick up $HOME/wg/wg0.conf
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
          ping -c 3 google.com

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'  # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
          cache: 'pip'
          cache-dependency-path: 'requirements-parser.txt'  # –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

      - name: Install parser requirements with retry
        run: |
          function install_with_retry {
            local retries=5
            local delay=15
            local success=0
            
            for ((i=1; i<=retries; i++)); do
              if pip install --default-timeout=100 -r requirements-parser.txt; then
                success=1
                break
              else
                echo "Attempt $i failed. Retrying in $delay seconds..."
                sleep $delay
              fi
            done
            
            if [ "$success" -ne 1 ]; then
              echo "Failed to install requirements after $retries attempts"
              exit 1
            fi
          }
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
          if [ ! -f "requirements-parser.txt" ]; then
            echo "Error: requirements-parser.txt not found!"
            ls -la
            exit 1
          fi
          
          install_with_retry

      - name: üß† Run parser
        run: python3 main.py --lang ru --posted-file articles/posted.json

      - name: Apply watermarks
        run: |
          pip install pillow
          python3 watermark_rotator.py

      - name: üõë Teardown WireGuard
        if: always()
        run: sudo wg-quick down $HOME/wg/wg0.conf || true

      - name: Upload parsed-content
        uses: actions/upload-artifact@v4
        with:
          name: parsed-content
          path: articles/*

  post:
    name: Publish new articles
    needs: parse
    runs-on: ubuntu-latest
    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'requirements-poster.txt'

      - name: Install poster requirements
        run: |
          if [ ! -f "requirements-poster.txt" ]; then
            echo "Error: requirements-poster.txt not found!"
            ls -la
            exit 1
          fi
          pip install -r requirements-poster.txt

      - name: Download parsed-content
        uses: actions/download-artifact@v4
        with:
          name: parsed-content
          path: parsed_articles

      - name: Run poster
        run: |
          python3 poster.py \
            --parsed-dir parsed_articles \
            --state-file articles/posted.json \
            --limit $BATCH_LIMIT

      - name: Commit updated posted.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add articles/posted.json
          if ! git diff --cached --quiet; then
            git commit -m "chore: update posted catalog after posting"
            git push
          fi
