name: –ü–æ—Å—Ç–µ—Ä

on:
  workflow_run:
    workflows: ["–ü–∞—Ä—Å–µ—Ä"]
    types:
      - complete
    
  workflow_dispatch:

jobs:
  run-poster:
    runs-on: ubuntu-latest

    steps:
    - name: üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: üì¶ –ö–µ—à pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements-*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: pip3 install -r requirements-poster.txt

    - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –∫–∞—Ç–∞–ª–æ–≥–∞
      uses: actions/download-artifact@v4
      with:
        name: parsed-content
        path: articles/

    - name: üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ catalog.json
      run: |
        if [ ! -f "articles/catalog.json" ]; then
          echo "‚ö†Ô∏è catalog.json –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –Ω–µ—á–µ–≥–æ –ø–æ—Å—Ç–∏—Ç—å"
          exit 0
        fi
        
    - name: üì§ –ó–∞–ø—É—Å–∫ –ø–æ—Å—Ç–µ—Ä–∞
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
      run: |
        python3 poster.py || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ poster.py"

    - name: üìù –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø–æ—Å–ª–µ –ø–æ—Å—Ç–∏–Ω–≥–∞
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: catalog-after-posting-${{ github.run_id }}
        path: articles/catalog.json
