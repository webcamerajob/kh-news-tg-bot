name: "Khmertimes: AI Parse & Post"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0,6,12,18 * * *'

permissions:
  contents: write

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    env:
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
      WG_CONFIG: ${{ secrets.WG_CONFIG }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install -r requirements-parser.txt
          if [ -f requirements-poster.txt ]; then pip install -r requirements-poster.txt; fi

      - name: ðŸ” Setup WireGuard
        run: |
          sudo apt-get update && sudo apt-get install -y wireguard-tools resolvconf
          echo "$WG_CONFIG" | sudo tee /etc/wireguard/wg0.conf > /dev/null
          sudo wg-quick up wg0

      - name: ðŸ§ª Step 1: Test AI Connection
        run: python3 test_ai.py

      - name: ðŸ” Step 2: Run Parser
        id: parse_step
        run: |
          python3 main.py \
            --base-url "https://www.khmertimeskh.com" \
            --slug "national" \
            --limit 15 \
            --posted-state-file articles/posted.json | tee parser_output.txt
          
          if grep -q "NEW_ARTICLES_STATUS:true" parser_output.txt; then
            echo "new_articles_found=true" >> $GITHUB_OUTPUT
          else
            echo "new_articles_found=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ›‘ Teardown WireGuard
        if: always()
        run: sudo wg-quick down wg0 || true

      - name: ðŸš€ Step 3: Run Poster
        if: steps.parse_step.outputs.new_articles_found == 'true'
        run: |
          python3 poster.py \
            --parsed-dir articles \
            --state-file articles/posted.json

      - name: ðŸ’¾ Step 4: Save Progress
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -f "articles/posted.json" ]; then
            git add articles/posted.json
            git diff --quiet && git diff --staged --quiet || (git commit -m "update: sync posted.json" && git push)
          fi
