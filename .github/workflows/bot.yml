name: Bot

on:
  push:
    branches: [main]
    
jobs:
  telegram-trigger:
    name: üöÄ Launch parser via Telegram
    runs-on: ubuntu-latest
    steps:

      - name: üîÑ Checkout
        uses: actions/checkout@v4

      - name: üíæ Install parser dependencies
        run: |
          if [ -f requirements-parser.txt ]; then
            pip install -r requirements-parser.txt
          else
            echo "‚ö†Ô∏è requirements-parser.txt –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É"
          fi
          
      - name: üì° Telegram Notify
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          CHANNEL=$(jq -r '.telegram_channel' settings.json)
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="$CHANNEL" -d text="‚úÖ –ó–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:\n$(jq . settings.json)"

      - name: üíæ Install parser dependencies
        run: pip install -r requirements-parser.txt
  
      - name: üîÑ Checkout
        uses: actions/checkout@v4

      - name: üß† Load settings
        run: |
          echo "üì• –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫"
          jq . settings.json

      - name: üßπ Reset published.json if requested
        run: |
          if jq -e '.published_reset' settings.json > /dev/null; then
            echo "{}" > articles/published.json
            jq '.published_reset = false' settings.json > tmp && mv tmp settings.json
            echo "‚ôªÔ∏è published.json —Å–±—Ä–æ—à–µ–Ω"
          else
            echo "‚ÑπÔ∏è –°–±—Ä–æ—Å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
          fi

      - name: üîç Run parser
        run: |
          BASE=$(jq -r '.base_url' settings.json)
          SLUG=$(jq -r '.slug' settings.json)
          LANG=$(jq -r '.lang' settings.json)
          python3 main.py --base-url "$BASE" --slug "$SLUG" --lang "$LANG"

      - name: üì§ Run poster
        run: |
          LIMIT=$(jq -r '.limit' settings.json)
          python3 poster.py --limit "$LIMIT"

      - name: üì° Telegram Notify (optional)
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          CHANNEL=$(jq -r '.telegram_channel' settings.json)
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="$CHANNEL" -d text="‚úÖ –ó–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:\n$(jq . settings.json)"
