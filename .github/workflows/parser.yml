name: –ü–∞—Ä—Å–µ—Ä —Å VPN (5:00‚Äì18:00 –∫–∞–∂–¥—ã–π 30 –º–∏–Ω)

on:
  schedule:
    - cron: '0,30 22-23 * * *'   # 05‚Äì06 –ø–æ –ò–Ω–¥–æ–∫–∏—Ç–∞—é (UTC+7)
    - cron: '0,30 0-10 * * *'    # 06‚Äì18 –ø–æ –ò–Ω–¥–æ–∫–∏—Ç–∞—é
  workflow_dispatch:

jobs:
  run-parser:
    runs-on: ubuntu-latest

    steps:
    - name: üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: üì¶ –ö–µ—à pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements-*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: pip3 install -r requirements-parser.txt

    - name: üìÅ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ WireGuard-–∫–æ–Ω—Ñ–∏–≥–∞
      run: |
        mkdir -p $HOME/wg
        echo "${{ secrets.WG_CONFIG }}" > $HOME/wg/wg0.conf
        chmod 600 $HOME/wg/wg0.conf

    - name: üîê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN –∏ DNS
      run: |
        sudo wg-quick up $HOME/wg/wg0.conf
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
        echo "üåê VPN IP: $(curl -s https://ipinfo.io/ip)"

    - name: üß† –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞
      run: |
        echo "‚Üí –ó–∞–ø—É—Å–∫ main.py..."
        python3 main.py || echo "‚ö†Ô∏è main.py –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"

    - name: üõë –û—Ç–∫–ª—é—á–µ–Ω–∏–µ VPN
      if: always()
      run: |
        echo "‚Üí –û—Ç–∫–ª—é—á–µ–Ω–∏–µ WireGuard..."
        sudo wg-quick down $HOME/wg/wg0.conf || echo "WireGuard —É–∂–µ –≤—ã–∫–ª—é—á–µ–Ω"
        
    - name: üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
      id: check_articles
      run: |
        if [ -d "articles" ] && [ "$(ls -A articles)" ]; then
          echo "üéØ –ù–∞–π–¥–µ–Ω–∞ –Ω–µ–ø—É—Å—Ç–∞—è –ø–∞–ø–∫–∞ articles/"
          echo "upload=true" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è –ü–∞–ø–∫–∞ articles/ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–∞"
          echo "upload=false" >> $GITHUB_OUTPUT
        fi

    - name: üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ —Å—Ç–∞—Ç–µ–π
      if: steps.check_articles.outputs.upload == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: parsed-content-${{ github.run_id }}
        path: articles/

