name: ÐŸÐ°Ñ€ÑÐµÑ€

on:
  schedule:
    - cron: '0,30 22-23 * * *'   # 05â€“06 Ð¿Ð¾ Ð˜Ð½Ð´Ð¾ÐºÐ¸Ñ‚Ð°ÑŽ (UTC+7)
    - cron: '0,30 0-10 * * *'    # 06â€“18 Ð¿Ð¾ Ð˜Ð½Ð´Ð¾ÐºÐ¸Ñ‚Ð°ÑŽ
  workflow_dispatch:

# ðŸ” ÐŸÑ€Ð°Ð²Ð° Ð´Ð»Ñ GITHUB_TOKEN
permissions:
  contents: read      # Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÐºÐ¾Ð´Ñƒ
  actions: write      # Ð´Ð»Ñ repository_dispatch

jobs:
  run-parser:
    runs-on: ubuntu-latest
    
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}    # â† Ð²Ð¾Ñ‚ Ð·Ð´ÐµÑÑŒ

    steps:
    - name: ðŸ”„ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      uses: actions/checkout@v4
          
    - name: ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: |
        sudo apt-get update
        sudo apt-get install -y wireguard-tools resolvconf curl python3-pip
        pip3 install -r requirements-parser.txt

    - name: ðŸ“ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° WireGuard-ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
      run: |
        mkdir -p $HOME/wg
        echo "${{ secrets.WG_CONFIG }}" > $HOME/wg/wg0.conf
        chmod 600 $HOME/wg/wg0.conf
        
    - name: ðŸ” ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ VPN Ð¸ DNS
      run: |
        sudo wg-quick up $HOME/wg/wg0.conf
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
        echo "ðŸŒ VPN IP: $(curl -s https://ipinfo.io/ip)"

    - name: ðŸ§  Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð°Ñ€ÑÐµÑ€Ð°
      run: |
        echo "â†’ Ð—Ð°Ð¿ÑƒÑÐº main.py..."
        python3 main.py || echo "âš ï¸ main.py Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹"

    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾ articles/
      run: |
        ls -la articles/
        cat articles/catalog.json || echo "âš ï¸ catalog.json Ð¿ÑƒÑÑ‚ Ð¸Ð»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
        
    - name: ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° catalog.json
      id: check_catalog
      run: |
        for i in 1 2; do
          if [ -f "articles/catalog.json" ]; then
            echo "âœ… catalog.json Ð½Ð°Ð¹Ð´ÐµÐ½"
            echo "upload=true" >> $GITHUB_OUTPUT
         else
            echo "âš ï¸ catalog.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
            echo "upload=false" >> $GITHUB_OUTPUT
         fi
        done
        if [ ! -f "articles/catalog.json" ]; then
          echo "âš ï¸ catalog.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          echo "upload=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸ›‘ ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ VPN
      if: always()
      run: |
        echo "â†’ ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ WireGuard..."
        sudo wg-quick down $HOME/wg/wg0.conf || echo "WireGuard ÑƒÐ¶Ðµ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½"

    - name: ðŸ“¦ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°
      if: steps.check_catalog.outputs.upload == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: parsed-content
        path: articles/
